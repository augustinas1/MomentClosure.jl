<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Common Issues · MomentClosure.jl</title><meta name="title" content="Common Issues · MomentClosure.jl"/><meta property="og:title" content="Common Issues · MomentClosure.jl"/><meta property="twitter:title" content="Common Issues · MomentClosure.jl"/><meta name="description" content="Documentation for MomentClosure.jl."/><meta property="og:description" content="Documentation for MomentClosure.jl."/><meta property="twitter:description" content="Documentation for MomentClosure.jl."/><meta property="og:url" content="https://augustinas1.github.io/MomentClosure.jl/tutorials/common_issues/"/><meta property="twitter:url" content="https://augustinas1.github.io/MomentClosure.jl/tutorials/common_issues/"/><link rel="canonical" href="https://augustinas1.github.io/MomentClosure.jl/tutorials/common_issues/"/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">MomentClosure.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Theory</span><ul><li><a class="tocitem" href="../../theory/moment_expansion_CME/">Moment Expansion (CME)</a></li><li><a class="tocitem" href="../../theory/moment_expansion_SDE/">Moment Expansion (SDE)</a></li><li><a class="tocitem" href="../../theory/moment_closure_approximations/">Moment Closure Approximations</a></li><li><a class="tocitem" href="../../theory/linear_mapping_approximation/">Linear Mapping Approximation</a></li></ul></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../using_momentclosure/">Using MomentClosure</a></li><li><a class="tocitem" href="../using_momentclosure_SDE/">Moment Equations from SDEs</a></li><li class="is-active"><a class="tocitem" href>Common Issues</a><ul class="internal"><li><a class="tocitem" href="#References"><span>References</span></a></li></ul></li><li><a class="tocitem" href="../time-dependent_propensities/">Time-dependent Propensity Functions</a></li><li><a class="tocitem" href="../geometric_reactions+conditional_closures/">Geometrically Distributed Reaction Products and Conditional Closures</a></li><li><a class="tocitem" href="../P53_system_example/">P53 System Example</a></li><li><a class="tocitem" href="../derivative_matching_example/">Derivative Matching Example</a></li><li><a class="tocitem" href="../SIR_example/">SIR Model Example</a></li><li><a class="tocitem" href="../LMA_example/">LMA Example</a></li><li><a class="tocitem" href="../parameter_estimation_SDE/">Parameter Estimation of Diffusion Processes</a></li></ul></li><li><span class="tocitem">API</span><ul><li><a class="tocitem" href="../../api/momentclosure_api/">MomentClosure.jl API</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>Common Issues</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Common Issues</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/augustinas1/MomentClosure.jl/blob/main/docs/src/tutorials/common_issues.md#L" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="common_issues"><a class="docs-heading-anchor" href="#common_issues">Common Issues</a><a id="common_issues-1"></a><a class="docs-heading-anchor-permalink" href="#common_issues" title="Permalink"></a></h1><p>Moment closure approximations are based on <em>ad hoc</em> assumptions and no rigorous and general predictions can be made on whether the results will be accurate or even physically meaningful [1-2]. Moreover, the truncated moment equations are prone to numerical instabilities and it may not be possible to solve them for the entire time course [3]. In this tutorial, we walk through a number of such issues encountered in the analysis of the Brusselator model introduced in the <a href="../using_momentclosure/">previous tutorial</a>.</p><p>We first redefine the system and its parameters for completeness:</p><pre><code class="language-julia hljs">using MomentClosure, Catalyst, OrdinaryDiffEq, Plots

rn = @reaction_network begin
  @parameters c₁ c₂ c₃ c₄ Ω
  (c₁/Ω^2), 2X + Y → 3X
  (c₂), X → Y
  (c₃*Ω, c₄), 0 ↔ X
end

pmap = [:c₁ =&gt; 0.9, :c₂ =&gt; 2, :c₃ =&gt; 1, :c₄ =&gt; 1, :Ω =&gt; 100]
u0map = [:X =&gt; 1, :Y =&gt; 1]
tspan = (0., 100.)

raw_eqs = generate_raw_moment_eqs(rn, 2, combinatoric_ratelaws=false)</code></pre><p>As we have seen earlier, second-order moment expansion using normal closure approximates the true system dynamics sufficiently accurately but it&#39;s interesting to see how other closures compare. Let&#39;s try applying zero closure:</p><pre><code class="language-julia hljs">closed_raw_eqs = moment_closure(raw_eqs, &quot;zero&quot;)

oprob = ODEProblem(closed_raw_eqs, u0map, tspan, pmap)
sol = solve(oprob, Tsit5(), saveat=0.1)

plot(sol, idxs=[1,2], lw=2)</code></pre><p><img src="../../assets/brusselator_issue_1.svg" alt="Brusselator issue 1"/></p><p>The trajectory of <span>$μ₀₁$</span> becomes negative and so zero closure fails to provide physically meaningful results for this parameter set. Note that is important to correctly choose the ODE solver depending on the stiffness of the system and the accuracy required. We tried a number of <a href="https://diffeq.sciml.ai/stable/solvers/ode_solve/">recommended DifferentialEquations solvers</a> here but none seemed to improve the results.</p><p>Let&#39;s apply log-normal closure next:</p><pre><code class="language-julia hljs">closed_raw_eqs = moment_closure(raw_eqs, &quot;log-normal&quot;)

oprob = ODEProblem(closed_raw_eqs, u0map, tspan, pmap)
sol = solve(oprob, Tsit5(), saveat=0.1)

plot(sol, idxs=[1,2], lw=2, legend=:bottomright)</code></pre><p><img src="../../assets/brusselator_issue_2.svg" alt="Brusselator issue 2"/></p><p>We observe sustained oscillatory behaviour instead of the expected damped oscillations. This result is unphysical: single SSA trajectories (that may display sustained oscillations) get dephased over time and hence the ensemble average should always show damped or overdamped oscillations [1].</p><p>Normal closure is also quite fragile. This can be seen by simply including the combinatorial scaling of the mass-action propensity functions with <code>combinatoric_ratelaw=true</code> which leads to unphysical sustained oscillatory trajectories:</p><pre><code class="language-julia hljs">raw_eqs = generate_raw_moment_eqs(rn, 2, combinatoric_ratelaws=true)
closed_raw_eqs = moment_closure(raw_eqs, &quot;normal&quot;)

oprob = ODEProblem(closed_raw_eqs, u0map, tspan, pmap)
sol = solve(oprob, Tsit5(), saveat=0.1)

plot(sol, idxs=[1,2], lw=2)</code></pre><p><img src="../../assets/brusselator_issue_3.svg" alt="Brusselator issue 3"/></p><p>Nevertheless, this can be improved upon by increasing the order of moment expansion:</p><pre><code class="language-julia hljs">raw_eqs = generate_raw_moment_eqs(rn, 3, combinatoric_ratelaws=true)
closed_raw_eqs = moment_closure(raw_eqs, &quot;normal&quot;)

oprob = ODEProblem(closed_raw_eqs, u0map, tspan, pmap)
sol = solve(oprob, Tsit5(), saveat=0.1)

plot(sol, idxs=[1,2], lw=2, legend=:bottomright)</code></pre><p><img src="../../assets/brusselator_issue_4.svg" alt="Brusselator issue 4"/></p><p>Some dampening in the system is now visible. Increasing the expansion order to <code>4</code> finally leads to physically sensible results:</p><pre><code class="language-julia hljs">raw_eqs = generate_raw_moment_eqs(rn, 4, combinatoric_ratelaws=true)
closed_raw_eqs = moment_closure(raw_eqs, &quot;normal&quot;)

oprob = ODEProblem(closed_raw_eqs, u0map, tspan, pmap)
sol = solve(oprob, Tsit5(), saveat=0.1)

plot(sol, idxs=[1,2], lw=2)</code></pre><p><img src="../../assets/brusselator_issue_5.svg" alt="Brusselator issue 5"/></p><p>For dessert, we consider unphysical divergent trajectories—a frequent problem with moment equations [3]. A good example is the second-order moment expansion including the combinatorial scaling of propensities with log-normal closure applied:</p><pre><code class="language-julia hljs">raw_eqs = generate_raw_moment_eqs(rn, 2, combinatoric_ratelaws=true)
closed_raw_eqs = moment_closure(raw_eqs, &quot;log-normal&quot;)

oprob = ODEProblem(closed_raw_eqs, u0map, tspan, pmap)
sol = solve(oprob, Rodas4P(), saveat=0.1)

plot(sol, idxs=[1,2], lw=2)</code></pre><p><img src="../../assets/brusselator_issue_6.svg" alt="Brusselator issue 6"/></p><p>In contrast to normal closure, increasing the expansion order makes the problem worse:</p><pre><code class="language-julia hljs">raw_eqs = generate_raw_moment_eqs(rn, 3, combinatoric_ratelaws=true)
closed_raw_eqs = moment_closure(raw_eqs, &quot;log-normal&quot;)

oprob = ODEProblem(closed_raw_eqs, u0map, tspan, pmap)
sol = solve(oprob, Rodas4P(), saveat=0.1)

plot(sol, idxs=[1,2], lw=2)</code></pre><pre><code class="language-julia hljs">┌ Warning: Interrupted. Larger maxiters is needed.
└ @ SciMLBase C:\Users\asukys\.julia\packages\SciMLBase\Afx1r\src\integrator_interface.jl:331</code></pre><p><img src="../../assets/brusselator_issue_7.svg" alt="Brusselator issue 7"/></p><p>Note that the solver throws a warning being unable to evaluate the trajectories for the entire time course (other solvers perform similarly in this case). This usually implies that the moment ODE system is too stiff and cannot be solved: the time derivatives grow unboundedly and the solver timestep is being constantly reduced, requiring an ever-increasing number of the solver iterations (hence the <a href="https://docs.sciml.ai/DiffEqDocs/stable/basics/faq/#A-larger-maxiters-seems-to-be-needed,-but-it&#39;s-already-high?"><code>maxiters</code></a> warning).</p><h2 id="References"><a class="docs-heading-anchor" href="#References">References</a><a id="References-1"></a><a class="docs-heading-anchor-permalink" href="#References" title="Permalink"></a></h2><p>[1]: D. Schnoerr, G. Sanguinetti, and R. Grima, &quot;Comparison of different moment-closure approximations for stochastic chemical kinetics&quot;, The Journal of Chemical Physics 143, 185101 (2015). <a href="https://doi.org/10.1063/1.4934990">https://doi.org/10.1063/1.4934990</a></p><p>[2]: D. Schnoerr, G. Sanguinetti, and R. Grima, &quot;Validity conditions for moment closure approximations in stochastic chemical kinetics&quot;, The Journal of Chemical Physics 141, 084103 (2014). <a href="https://doi.org/10.1063/1.4892838">https://doi.org/10.1063/1.4892838</a></p><p>[3]: E. Lakatos, A. Ale, P. D. W. Kirk, and M. P. H. Stumpf, &quot;Multivariate moment closure techniques for stochastic kinetic models&quot;, The Journal of Chemical Physics 143, 094107 (2015). <a href="https://doi.org/10.1063/1.4929837">https://doi.org/10.1063/1.4929837</a></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../using_momentclosure_SDE/">« Moment Equations from SDEs</a><a class="docs-footer-nextpage" href="../time-dependent_propensities/">Time-dependent Propensity Functions »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.11.4 on <span class="colophon-date" title="Monday 2 June 2025 08:43">Monday 2 June 2025</span>. Using Julia version 1.11.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
