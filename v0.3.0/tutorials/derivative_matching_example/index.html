<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Derivative Matching Example · MomentClosure.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://augustinas1.github.io/MomentClosure.jl/tutorials/derivative_matching_example/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">MomentClosure.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Theory</span><ul><li><a class="tocitem" href="../../theory/moment_expansion_CME/">Moment Expansion (CME)</a></li><li><a class="tocitem" href="../../theory/moment_expansion_SDE/">Moment Expansion (SDE)</a></li><li><a class="tocitem" href="../../theory/moment_closure_approximations/">Moment Closure Approximations</a></li><li><a class="tocitem" href="../../theory/linear_mapping_approximation/">Linear Mapping Approximation</a></li></ul></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../using_momentclosure/">Using MomentClosure</a></li><li><a class="tocitem" href="../using_momentclosure_SDE/">Moment Equations from SDEs</a></li><li><a class="tocitem" href="../common_issues/">Common Issues</a></li><li><a class="tocitem" href="../time-dependent_propensities/">Time-dependent Propensity Functions</a></li><li><a class="tocitem" href="../geometric_reactions+conditional_closures/">Geometrically Distributed Reaction Products and Conditional Closures</a></li><li><a class="tocitem" href="../P53_system_example/">P53 System Example</a></li><li class="is-active"><a class="tocitem" href>Derivative Matching Example</a><ul class="internal"><li><a class="tocitem" href="#References"><span>References</span></a></li></ul></li><li><a class="tocitem" href="../SIR_example/">SIR Model Example</a></li><li><a class="tocitem" href="../LMA_example/">LMA Example</a></li><li><a class="tocitem" href="../parameter_estimation_SDE/">Parameter Estimation of Diffusion Processes</a></li></ul></li><li><span class="tocitem">API</span><ul><li><a class="tocitem" href="../../api/momentclosure_api/">MomentClosure.jl API</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>Derivative Matching Example</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Derivative Matching Example</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/augustinas1/MomentClosure.jl/blob/main/docs/src/tutorials/derivative_matching_example.md#L" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="derivative-matching-example"><a class="docs-heading-anchor" href="#derivative-matching-example">Derivative Matching Example</a><a id="derivative-matching-example-1"></a><a class="docs-heading-anchor-permalink" href="#derivative-matching-example" title="Permalink"></a></h1><p>In this example, we aim to reproduce a number of results from the original <a href="../../theory/moment_closure_approximations/#derivative_matching">derivative matching</a> paper by Singh and Hespanha [1]. We consider the bimolecular reaction system given by:</p><p class="math-container">\[\begin{align*}
X_1 &amp;\stackrel{c_1}{\rightarrow} 2X_1 + X_2, \\
X_1 + X_2&amp;\stackrel{c_2}{\rightarrow} X_2.
\end{align*}\]</p><p>The reaction network and its parameters can be defined as follows:</p><pre><code class="language-julia hljs">using Catalyst

rn = @reaction_network begin
    @parameters c₁ c₂
    (c₁), x₁ → 2x₁+x₂
    (c₂), x₁+x₂ → x₂
end

# parameter values
p = [1.0, 1.0]
# initial conditions
u0 = [20, 10]
# time interval to solve on
tspan = (0., 0.5)</code></pre><p>We are interested in extracting the time-evolution of a specific third order cumulant, <span>$κ_{03}$</span>, using second and third order moment expansions with derivative matching, and comparing the obtained estimates to the SSA prediction.</p><p>Let&#39;s start with a second order moment expansion and print out the third-order moment closure functions obtained with derivative matching:</p><pre><code class="language-julia hljs">using MomentClosure, Latexify

eqs2 = generate_raw_moment_eqs(rn, 2)
dm2_eqs = moment_closure(eqs2, &quot;derivative matching&quot;)
latexify(dm2_eqs, :closure, print_all=true)</code></pre><p class="math-container">\[\begin{align*}
\mu{_{30}} =&amp; \mu{_{10}}^{-3} \mu{_{20}}^{3} \\
\mu{_{21}} =&amp; \mu{_{20}} \mu{_{01}}^{-1} \mu{_{10}}^{-2} \mu{_{11}}^{2} \\
\mu{_{12}} =&amp; \mu{_{02}} \mu{_{01}}^{-2} \mu{_{10}}^{-1} \mu{_{11}}^{2} \\
\mu{_{03}} =&amp; \mu{_{01}}^{-3} \mu{_{02}}^{3}
\end{align*}\]</p><p>Note that all closure functions are consistent with the ones shown in Table II of [1]. We can then move on to solving the generated system of moment ODEs:</p><pre><code class="language-julia hljs">using OrdinaryDiffEq

u0map = deterministic_IC(u0, dm2_eqs) # assuming deterministic initial conditions
oprob = ODEProblem(dm2_eqs, u0map, tspan, p)
dm2_sol = solve(oprob, Tsit5(), saveat=0.01)</code></pre><p>Now the question is how can we extract the time evolution of the cumulant <span>$\kappa_{03}$</span>. Firstly, note that using the standard moment relationships it can be expressed in terms of raw moments as:</p><p class="math-container">\[\begin{align*}
\kappa_{03} = 2 \mu_{01}^3 - 3\mu_{02}\mu_{01} + \mu_{03}
\end{align*}\]</p><p>As we were solving for moments up to second order, we do not have any direct information on the third order moment <span>$\mu_{03}$</span>. Nevertheless, we can manually approximate it using the corresponding closure function given above, i.e., <span>$\mu_{03} = \mu_{01}^{-3} \mu_{02}^{3}$</span>. The time trajectories of <span>$\mu_{01}$</span> and <span>$\mu_{02}$</span> can be extracted from <code>dm2_sol</code> and their order in the array can be checked with:</p><pre><code class="language-julia hljs">dm2_eqs.odes.states</code></pre><pre><code class="language-julia hljs">5-element Array{Term{Real,Nothing},1}:
 μ₁₀(t)
 μ₀₁(t)
 μ₂₀(t)
 μ₁₁(t)
 μ₀₂(t)</code></pre><p>Finally, we can combine all the steps to obtain the <span>$\kappa_{03}$</span> estimate:</p><pre><code class="language-julia hljs">μ₀₁ = dm2_sol[2, :]
μ₀₂ = dm2_sol[5, :]
μ₀₃ = (μ₀₁ .^(-3)) .* (μ₀₂ .^3)
dm2_κ₀₃ = 2 .* μ₀₁ .^3 .- 3 .* μ₀₂ .* μ₀₁ .+ μ₀₃</code></pre><p>Next we consider a third order moment expansion:</p><pre><code class="language-julia hljs">eqs3 = generate_raw_moment_eqs(rn, 3)
dm3_eqs = moment_closure(eqs3, &quot;derivative matching&quot;)
latexify(dm3_eqs, :closure, print_all=true)</code></pre><p class="math-container">\[\begin{align*}
\mu{_{40}} =&amp; \mu{_{10}}^{4} \mu{_{20}}^{-6} \mu{_{30}}^{4} \\
\mu{_{31}} =&amp; \mu{_{01}} \mu{_{30}} \mu{_{10}}^{3} \mu{_{11}}^{-3} \mu{_{20}}^{-3} \mu{_{21}}^{3} \\
\mu{_{22}} =&amp; \mu{_{01}}^{2} \mu{_{02}}^{-1} \mu{_{10}}^{2} \mu{_{11}}^{-4} \mu{_{12}}^{2} \mu{_{20}}^{-1} \mu{_{21}}^{2} \\
\mu{_{13}} =&amp; \mu{_{03}} \mu{_{10}} \mu{_{01}}^{3} \mu{_{02}}^{-3} \mu{_{11}}^{-3} \mu{_{12}}^{3} \\
\mu{_{04}} =&amp; \mu{_{01}}^{4} \mu{_{02}}^{-6} \mu{_{03}}^{4}
\end{align*}\]</p><p>As expected, the closure functions agree with those given in Table III of [1]. We again check the order of variables</p><pre><code class="language-julia hljs">dm3_eqs.odes.states</code></pre><pre><code class="language-julia hljs">9-element Array{Term{Real,Nothing},1}:
 μ₁₀(t)
 μ₀₁(t)
 μ₂₀(t)
 μ₁₁(t)
 μ₀₂(t)
 μ₃₀(t)
 μ₂₁(t)
 μ₁₂(t)
 μ₀₃(t)</code></pre><p>and solve the moment equations, computing the required cumulant:</p><pre><code class="language-julia hljs">u0map = deterministic_IC(u0, dm3_eqs)
oprob = ODEProblem(dm3_eqs, u0map, tspan, p)
dm3_sol = solve(oprob, Tsit5(), saveat=0.01, abstol=1e-8, reltol=1e-8)

μ₀₁ = dm3_sol[2,:]
μ₀₂ = dm3_sol[5,:]
μ₀₃ = dm3_sol[9,:]
dm3_κ₀₃ = 2 .* μ₀₁ .^ 3 - 3 .* μ₀₂ .* μ₀₁ .+ μ₀₃</code></pre><p>Note that we could have also obtained <span>$\kappa_{03}$</span> estimate in an easier way by using central moment equations, as third order central moments are equal to the corresponding third order cumulants:</p><pre><code class="language-julia hljs">central_eqs3 = generate_central_moment_eqs(rn, 3)
dm3_central_eqs = moment_closure(central_eqs3, &quot;derivative matching&quot;)

u0map = deterministic_IC(u0, dm3_central_eqs)
oprob = ODEProblem(dm3_central_eqs, u0map, tspan, p)
dm3_central_sol = solve(oprob, Tsit5(), saveat=0.01, abstol=1e-8, reltol=1e-8)

# check that the two estimates are equivalent
dm3_κ₀₃ ≈ dm3_central_sol[9,:]</code></pre><pre><code class="language-julia hljs">true</code></pre><p>The last ingredient we need for a proper comparison between the second and third order moment expansions is a reference value predicted by the SSA. We can simulate <span>$10^5$</span> SSA trajectories as follows:</p><pre><code class="language-julia hljs">using JumpProcesses

dprob = DiscreteProblem(rn, u0, tspan, p)
jprob = JumpProblem(rn, dprob, Direct(), save_positions=(false, false))

ensembleprob  = EnsembleProblem(jprob)
@time sol_SSA = solve(ensembleprob, SSAStepper(), saveat=0.01, trajectories=100000)</code></pre><pre><code class="language-julia hljs">3.874558 seconds (7.45 M allocations: 714.845 MiB, 46.60% gc time)</code></pre><p>The time evolution of <span>$\kappa_{03}$</span> can be extracted from SSA data using the <a href="../../api/momentclosure_api/#MomentClosure.get_cumulants"><code>get_cumulants</code></a> function:</p><pre><code class="language-julia hljs">ssa_κ₀₃ = get_cumulants(sol_SSA, 3)[0, 3]</code></pre><p>Finally, we plot the results:</p><pre><code class="language-julia hljs">using Plots, LaTeXStrings

plot(dm2_sol.t, dm2_κ₀₃, lw=2, label=&quot;2nd order DM&quot;)
plot!(dm2_sol.t, dm3_κ₀₃, lw=2, label=&quot;3rd order DM&quot;)
plot!(dm2_sol.t, ssa_κ₀₃, lw=2, label=&quot;SSA&quot;)
plot!(ylabel=L&quot;\kappa_{03}&quot;, xlabel=L&quot;t&quot;, guidefontsize=14, legend=:bottomright)</code></pre><p><img src="../../assets/derivative_matching_cumulant.svg" alt="Derivative Matching cumulant"/></p><p>We observe that the third order moment truncation using derivative matching performs significantly better than the second order truncation, accurately matching the true SSA prediction (consistent with the figure in [1]).</p><p>It is also interesting to note that the closure functions of third order moments obtained using <a href="../../theory/moment_closure_approximations/#derivative_matching">derivative matching</a> and <a href="../../theory/moment_closure_approximations/#log-normal_closure">log-normal</a> closures are equivalent. We can see that it is indeed the case by printing out the log-normal closure functions</p><pre><code class="language-julia hljs">ln2_eqs = moment_closure(eqs2, &quot;log-normal&quot;)
latexify(ln2_eqs, :closure, print_all=true)</code></pre><p class="math-container">\[\begin{align*}
\mu{_{30}} =&amp; \mu{_{10}}^{-3} \mu{_{20}}^{3} \\
\mu{_{21}} =&amp; \mu{_{20}} \mu{_{01}}^{-1} \mu{_{10}}^{-2} \mu{_{11}}^{2} \\
\mu{_{12}} =&amp; \mu{_{02}} \mu{_{01}}^{-2} \mu{_{10}}^{-1} \mu{_{11}}^{2} \\
\mu{_{03}} =&amp; \mu{_{01}}^{-3} \mu{_{02}}^{3}
\end{align*}\]</p><p>and the corresponding derivative matching functions obtained previously:</p><pre><code class="language-julia hljs">latexify(dm2_eqs, :closure, print_all=true)</code></pre><p class="math-container">\[\begin{align*}
\mu{_{30}} =&amp; \mu{_{10}}^{-3} \mu{_{20}}^{3} \\
\mu{_{21}} =&amp; \mu{_{20}} \mu{_{01}}^{-1} \mu{_{10}}^{-2} \mu{_{11}}^{2} \\
\mu{_{12}} =&amp; \mu{_{02}} \mu{_{01}}^{-2} \mu{_{10}}^{-1} \mu{_{11}}^{2} \\
\mu{_{03}} =&amp; \mu{_{01}}^{-3} \mu{_{02}}^{3}
\end{align*}\]</p><p>However, the equivalence holds only for third order moments. For example, the closure functions of fourth order moments differ:</p><pre><code class="language-julia hljs">ln3_eqs = moment_closure(eqs3, &quot;log-normal&quot;)
latexify(ln3_eqs, :closure, print_all=true)</code></pre><p class="math-container">\[\begin{align*}
\mu{_{40}} =&amp; \mu{_{10}}^{-8} \mu{_{20}}^{6} \\
\mu{_{31}} =&amp; \mu{_{01}}^{-2} \mu{_{10}}^{-6} \mu{_{11}}^{3} \mu{_{20}}^{3} \\
\mu{_{22}} =&amp; \mu{_{02}} \mu{_{20}} \mu{_{01}}^{-4} \mu{_{10}}^{-4} \mu{_{11}}^{4} \\
\mu{_{13}} =&amp; \mu{_{01}}^{-6} \mu{_{02}}^{3} \mu{_{10}}^{-2} \mu{_{11}}^{3} \\
\mu{_{04}} =&amp; \mu{_{01}}^{-8} \mu{_{02}}^{6}
\end{align*}\]</p><pre><code class="language-julia hljs">latexify(dm3_eqs, :closure, print_all=true)</code></pre><p class="math-container">\[\begin{align*}
\mu{_{40}} =&amp; \mu{_{10}}^{4} \mu{_{20}}^{-6} \mu{_{30}}^{4} \\
\mu{_{31}} =&amp; \mu{_{01}} \mu{_{30}} \mu{_{10}}^{3} \mu{_{11}}^{-3} \mu{_{20}}^{-3} \mu{_{21}}^{3} \\
\mu{_{22}} =&amp; \mu{_{01}}^{2} \mu{_{02}}^{-1} \mu{_{10}}^{2} \mu{_{11}}^{-4} \mu{_{12}}^{2} \mu{_{20}}^{-1} \mu{_{21}}^{2} \\
\mu{_{13}} =&amp; \mu{_{03}} \mu{_{10}} \mu{_{01}}^{3} \mu{_{02}}^{-3} \mu{_{11}}^{-3} \mu{_{12}}^{3} \\
\mu{_{04}} =&amp; \mu{_{01}}^{4} \mu{_{02}}^{-6} \mu{_{03}}^{4}
\end{align*}\]</p><p>This difference is expected as fourth order moments using log-normal closure are expressed exclusively in terms of first and second order moments, whereas derivative matching additionally incorporates third order moment information. Singh and Hespanha [1, 2] elaborate on this point: as there is no unique way to define higher order moment closure functions for log-normal distribution, both closures are consistent with the assumption that the population is jointly log-normally distributed. We urge the reader to consult the mentioned papers [1, 2] and the references therein for a more complete discussion comparing the two approaches.</p><h2 id="References"><a class="docs-heading-anchor" href="#References">References</a><a id="References-1"></a><a class="docs-heading-anchor-permalink" href="#References" title="Permalink"></a></h2><p>[1]: A.  Singh  and  J.  P.  Hespanha,  &quot;Lognormal  Moment  Closures  for  Biochemical  Reactions&quot;, in Proceedings of the 45th IEEE Conference on Decision and Control, ISSN:0191-2216 (Dec. 2006), pp. 2063–2068. <a href="https://doi.org/10.1109/CDC.2006.376994">https://doi.org/10.1109/CDC.2006.376994</a></p><p>[2]: A. Singh and J. P. Hespanha, &quot;Approximate Moment Dynamics for Chemically Reacting Systems&quot;, IEEE Transactions on Automatic Control 56, 414–418 (2011). <a href="https://doi.org/10.1109/TAC.2010.2088631">https://doi.org/10.1109/TAC.2010.2088631</a></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../P53_system_example/">« P53 System Example</a><a class="docs-footer-nextpage" href="../SIR_example/">SIR Model Example »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.24 on <span class="colophon-date" title="Saturday 6 May 2023 01:14">Saturday 6 May 2023</span>. Using Julia version 1.8.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
