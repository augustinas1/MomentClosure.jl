<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Moment Equations from SDEs · MomentClosure.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://augustinas1.github.io/MomentClosure.jl/tutorials/using_momentclosure_SDE/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.039/juliamono-regular.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><script src="../../../copy.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">MomentClosure.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Theory</span><ul><li><a class="tocitem" href="../../theory/moment_expansion_CME/">Moment Expansion (CME)</a></li><li><a class="tocitem" href="../../theory/moment_expansion_SDE/">Moment Expansion (SDE)</a></li><li><a class="tocitem" href="../../theory/moment_closure_approximations/">Moment Closure Approximations</a></li><li><a class="tocitem" href="../../theory/linear_mapping_approximation/">Linear Mapping Approximation</a></li></ul></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../using_momentclosure/">Using MomentClosure</a></li><li class="is-active"><a class="tocitem" href>Moment Equations from SDEs</a><ul class="internal"><li><a class="tocitem" href="#Model-1"><span>Model 1</span></a></li><li><a class="tocitem" href="#Model-2"><span>Model 2</span></a></li><li><a class="tocitem" href="#References"><span>References</span></a></li></ul></li><li><a class="tocitem" href="../common_issues/">Common Issues</a></li><li><a class="tocitem" href="../time-dependent_propensities/">Time-dependent Propensity Functions</a></li><li><a class="tocitem" href="../geometric_reactions+conditional_closures/">Geometrically Distributed Reaction Products and Conditional Closures</a></li><li><a class="tocitem" href="../P53_system_example/">P53 System Example</a></li><li><a class="tocitem" href="../derivative_matching_example/">Derivative Matching Example</a></li><li><a class="tocitem" href="../SIR_example/">SIR Model Example</a></li><li><a class="tocitem" href="../LMA_example/">LMA Example</a></li><li><a class="tocitem" href="../parameter_estimation_SDE/">Parameter Estimation of Diffusion Processes</a></li></ul></li><li><span class="tocitem">API</span><ul><li><a class="tocitem" href="../../api/momentclosure_api/">MomentClosure.jl API</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>Moment Equations from SDEs</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Moment Equations from SDEs</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/augustinas1/MomentClosure.jl/blob/master/docs/src/tutorials/using_momentclosure_SDE.md#L" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="tutorial_SDE"><a class="docs-heading-anchor" href="#tutorial_SDE">Moment Equations from SDEs</a><a id="tutorial_SDE-1"></a><a class="docs-heading-anchor-permalink" href="#tutorial_SDE" title="Permalink"></a></h1><p>In the <a href="../using_momentclosure/#main_tutorial">previous tutorial</a>, we have shown how to generate and <em>close</em> moment equations for chemical reaction networks. Similarly, MomentClosure can be applied to systems of stochastic differential equations (SDEs) and here we demonstrate this functionality by working through a couple of practical examples. Namely, we consider two specific models from a relevant paper by <a href="https://doi.org/10.1109/CDC.2017.8263922">Ghusinga et al. (2017)</a> [1], 1) the Van der Pol oscillator and 2) a swinging pendulum, and apply moment closure approximations (MA) to reproduce some of the published results. For the theory behind the SDE moment expansion <a href="../../theory/moment_expansion_SDE/#moment_expansion_SDE">see here</a>.</p><h2 id="Model-1"><a class="docs-heading-anchor" href="#Model-1">Model 1</a><a id="Model-1-1"></a><a class="docs-heading-anchor-permalink" href="#Model-1" title="Permalink"></a></h2><p>The deterministic Van der Pol oscillator is described by [1]:</p><p class="math-container">\[\begin{align*}
    \frac{d^2 x}{dt^2} - \epsilon(1-x^2)\frac{dx}{dt} + \omega_n^2 x = A\cos(\omega_g t),
\end{align*}\]</p><p>where <span>$\epsilon$</span> is the bifurcation parameter, <span>$\omega_n$</span> the natural frequency, <span>$\omega_g$</span> the force frequency and <span>$A$</span> the force amplitude. We formulate a stochastic equivalent of this system by assuming that the force is noisy and taking <span>$x_1 = x$</span> and <span>$x_2 = \frac{dx}{dt}$</span>, so that</p><p class="math-container">\[\begin{align*}
    dx_1 &amp;= x_2 dt, \\
    dx_2 &amp;= \left( \epsilon(1-x_1^2) x_2 - \omega_n^2 x_1 \right)dt + A\cos(\omega_g t)dt + A dw_t.
\end{align*}\]</p><p>In Julia, systems of SDEs can be conveniently described using <a href="https://github.com/SciML/ModelingToolkit.jl">ModelingToolkit.jl</a> that provides an <a href="https://mtk.sciml.ai/stable/systems/SDESystem/#ModelingToolkit.SDESystem"><code>SDESystem</code></a> type. Defining such models is straightforward (<a href="https://mtk.sciml.ai/stable/tutorials/stochastic_diffeq/">as in this example</a>) and in our case is done as follows:</p><pre><code class="language-julia hljs">using ModelingToolkit

@variables t, x₁(t), x₂(t)
@parameters ϵ, ω_n, ω_g, A

drift_eqs = [Differential(t)(x₁) ~ x₂;
             Differential(t)(x₂) ~ ϵ*(1-x₁^2)*x₂ - ω_n^2*x₁ + A*cos(ω_g*t)]
diff_eqs = [0; A]

vdp_model = SDESystem(drift_eqs, diff_eqs, t, [x₁, x₂], [ϵ, ω_n, ω_g, A], name = :VdP)

ps = [ϵ =&gt; 0.1, ω_n =&gt; 120*pi, ω_g =&gt; 120*pi, A =&gt; 2.5] # parameter values
u0 = [0.1, 0.1]   # initial conditions
tspan = (0., 0.1) # simulation time limit</code></pre><p>We can now easily extract the raw moment equations up to second order using MomentClosure</p><pre><code class="language-julia hljs">using MomentClosure, Latexify

moment_eqs = generate_raw_moment_eqs(vdp_model, 2) 
latexify(moment_eqs)</code></pre><p class="math-container">\[\begin{align*}
\frac{d\mu{_{10}}}{dt} =&amp; \mu{_{01}} \\
\frac{d\mu{_{01}}}{dt} =&amp; A \cos\left( t \omega_{g} \right) + \epsilon \mu{_{01}} - \epsilon \mu{_{21}} - \omega_{n}^{2} \mu{_{10}} \\
\frac{d\mu{_{20}}}{dt} =&amp; 2 \mu{_{11}} \\
\frac{d\mu{_{11}}}{dt} =&amp; \epsilon \mu{_{11}} + A \mu{_{10}} \cos\left( t \omega_{g} \right) + \mu{_{02}} - \epsilon \mu{_{31}} - \omega_{n}^{2} \mu{_{20}} \\
\frac{d\mu{_{02}}}{dt} =&amp; A^{2} + 2 \epsilon \mu{_{02}} + 2 A \mu{_{01}} \cos\left( t \omega_{g} \right) - 2 \omega_{n}^{2} \mu{_{11}} - 2 \epsilon \mu{_{22}}
\end{align*}\]</p><p>The obtained moment equations are equivalent to the published ones (except for a single term in <span>$\mu_{11}$</span> equation as there is a typo in the paper), giving some confidence that everything works as intended!</p><p>Note that the moment equations are not <em>closed</em> as there are two fourth order moments involved, <span>$\mu_{31}$</span> and <span>$\mu_{22}$</span>, and hence we need to resort to MAs. We proceed to apply the <a href="../../theory/moment_closure_approximations/#derivative_matching">derivative matching approximation</a> and solve the system of ODEs as follows:</p><pre><code class="language-julia hljs">using DifferentialEquations

closed_eqs = moment_closure(moment_eqs, &quot;derivative matching&quot;)

u0map = deterministic_IC(u0, closed_eqs)
oprob = ODEProblem(closed_eqs, u0map, tspan, ps)

sol_MA = solve(oprob, Tsit5(), saveat=0.0001)</code></pre><p>Finally, we can also use <a href="https://github.com/SciML/DifferentialEquations.jl"><code>DifferentialEquations</code></a> to <a href="https://diffeq.sciml.ai/stable/tutorials/sde_example/">solve the SDEs</a> for many trajectories and compare the ensemble statistics to the derivative matching approximation (getting a great match):</p><pre><code class="language-julia hljs">using DifferentialEquations.EnsembleAnalysis, Plots

prob_SDE = SDEProblem(vdp_model, u0, tspan, ps)
@time sol_SDE = solve(EnsembleProblem(prob_SDE), SRIW1(), saveat=0.0001, trajectories=100)
means_SDE = timeseries_steps_mean(sol_SDE)

plot(sol_MA.t, sol_MA[1, :], lw=2, label=&quot;MA&quot;, ylabel=&quot;⟨x₁⟩&quot;, xlabel=&quot;time&quot;)
plot!(sol_MA.t, means_SDE[1, :], lw=2, label=&quot;SDE&quot;, linecolor=:red,
      linestyle=:dash, background_color_legend=nothing, legend=:topright, grid=false)</code></pre><p><img src="../../assets/basic_SDE_model1.svg" alt="Model 1 SDE"/></p><h2 id="Model-2"><a class="docs-heading-anchor" href="#Model-2">Model 2</a><a id="Model-2-1"></a><a class="docs-heading-anchor-permalink" href="#Model-2" title="Permalink"></a></h2><p>We next consider a simple pendulum, deterministically described as [1]</p><p class="math-container">\[\begin{align*}
  \frac{d^2\theta}{dt^2} + \frac{k}{m}\frac{d\theta}{dt} + \frac{g}{l} \sin{\theta} = 0,
\end{align*}\]</p><p>where <span>$\theta$</span> is the angular displacement, <span>$m$</span> the mass of the pendulum, <span>$g$</span> the gravitational acceleration constant, <span>$l$</span> the pendulum length and <span>$k$</span> the friction constant. The stochasticity is modelled as a white noise term arising due to pendulum randomly interacting with air molecules (assumed to be inversely proportional to <span>$m$</span>). Letting <span>$x_1 = \theta$</span> and <span>$x_2 = \frac{d\theta}{dt}$</span> we write down the SDE as:</p><p class="math-container">\[\begin{align*}
    dx_1 &amp;= x_2 dt, \\
    dx_2 &amp;= \left( -\frac{k}{m}x_2 - \frac{g}{l}\sin{x_1} \right)dt + \frac{1}{m}dw_t.
\end{align*}\]</p><p>Using ModelingToolkit again we can define the model as</p><pre><code class="language-julia hljs">@variables t, x₁(t), x₂(t)
@parameters k, l, m, g

drift_eqs = [Differential(t)(x₁) ~ x₂;
             Differential(t)(x₂) ~ -k/m*x₂ - g/l*sin(x₁)]
diff_eqs = [0; 1/m]

pendulum_model = SDESystem(drift_eqs, diff_eqs, t, [x₁, x₂], [k, l, m, g], name = :pendulum)
ps = [k =&gt; 10, m =&gt; 10, l =&gt; 10, g =&gt; 10]
u0 = [3, 3]
tspan = (0., 15.)</code></pre><p>As the drift term is non-polynomial, we can no longer write down the raw moment equations in a straightforward manner. Nevertheless, we can <a href="../../theory/moment_expansion_SDE/#central_moment_eqs_SDE">expand</a> the expressions up to a certain <a href="../../theory/moment_expansion_CME/#central_moment_eqs">Taylor expansion order <span>$q$</span></a> and generate the corresponding time-evolution equations for the means and higher order central moments—this situation is identical to moment expansion for chemical reaction networks with non-polynomial propensities. Hence we can obtain the equations for the means and variances with <span>$q=3$</span>:</p><pre><code class="language-julia hljs">moment_eqs = generate_central_moment_eqs(pendulum_model, 2, 3) 
latexify(moment_eqs) # the output here is maybe not the most visually pleasing</code></pre><p class="math-container">\[\begin{align*}
\frac{d\mu{_{10}}}{dt} =&amp; \mu{_{01}} \\
\frac{d\mu{_{01}}}{dt} =&amp; \frac{\left(  - k \right) \mu{_{01}}}{m} + \frac{\left(  - g \right) \sin\left( \mu{_{10}} \right)}{l} + \frac{\frac{1}{6} g M{_{30}} \cos\left( \mu{_{10}} \right)}{l} + \frac{\frac{1}{2} g M{_{20}} \sin\left( \mu{_{10}} \right)}{l} \\
\frac{dM{_{20}}}{dt} =&amp; 2 M{_{11}} \\
\frac{dM{_{11}}}{dt} =&amp; \frac{\left(  - k \right) M{_{11}}}{m} + \frac{\left(  - g \right) M{_{20}} \cos\left( \mu{_{10}} \right)}{l} + \frac{\frac{1}{2} g M{_{30}} \sin\left( \mu{_{10}} \right)}{l} + M{_{02}} \\
\frac{dM{_{02}}}{dt} =&amp; \frac{\frac{1}{1}}{m^{2}} + \frac{-2 k M{_{02}}}{m} + \frac{g M{_{21}} \sin\left( \mu{_{10}} \right)}{l} + \frac{-2 g M{_{11}} \cos\left( \mu{_{10}} \right)}{l}
\end{align*}\]</p><p>We can now approximate the moment equations using <a href="../../theory/moment_closure_approximations/#gamma_closure">gamma closure</a>, solve the ODEs numerically and compare the predictions to true SDE solution, finding good agreement:</p><pre><code class="language-julia hljs">closed_eqs = moment_closure(moment_eqs, &quot;gamma&quot;)

u0map = deterministic_IC(u0, closed_eqs)
oprob = ODEProblem(closed_eqs, u0map, tspan, ps)
sol_MA = solve(oprob, Tsit5(), saveat=0.01)

prob_SDE = SDEProblem(pendulum_model, u0, tspan, ps)
sol_SDE = solve(EnsembleProblem(prob_SDE), SRIW1(), saveat=0.01, trajectories=100)
means_SDE = timeseries_steps_mean(sol_SDE)

plot(sol_MA.t, sin.(sol_MA[1, :]), lw=2, label=&quot;MA&quot;, ylabel=&quot;sin(⟨x₁⟩)&quot;, xlabel=&quot;time&quot;)
plot!(sol_MA.t, sin.(means_SDE[1, :]), lw=2, label=&quot;SDE&quot;, linecolor=:red,
    linestyle=:dash, background_color_legend=nothing, legend=:topright, grid=false)</code></pre><p><img src="../../assets/basic_SDE_model2.svg" alt="Model 2 SDE"/></p><h2 id="References"><a class="docs-heading-anchor" href="#References">References</a><a id="References-1"></a><a class="docs-heading-anchor-permalink" href="#References" title="Permalink"></a></h2><p>[1]: K. R. Ghusinga, M. Soltani, A. Lamperski, S. V. Dhople, and A. Singh, &quot;Approximate moment dynamics for polynomial and trigonometric stochastic systems&quot;, IEEE 56th Annual Conference on Decision and Control (2017). <a href="https://doi.org/10.1109/CDC.2017.8263922">https://doi.org/10.1109/CDC.2017.8263922</a></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../using_momentclosure/">« Using MomentClosure</a><a class="docs-footer-nextpage" href="../common_issues/">Common Issues »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.12 on <span class="colophon-date" title="Friday 11 February 2022 16:54">Friday 11 February 2022</span>. Using Julia version 1.7.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
